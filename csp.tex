\documentclass{amsart}
\usepackage[parfill]{parskip} 
\usepackage{amsmath,amssymb,amsthm}
\usepackage[pdftex]{hyperref}
\usepackage{euscript}

\hypersetup{
  colorlinks,
  citecolor=blue,
  filecolor=black,
  linkcolor=blue,
  urlcolor=black
}

\theoremstyle{plain}
\newtheorem{theorem}{Theorem}[section]
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{lemma}[theorem]{Lemma}


\theoremstyle{definition}
\newtheorem{definition}[theorem]{Definition}

\theoremstyle{remark}
\newtheorem{remark}[theorem]{Remark}

\def\phi{\varphi}
\def\E{\exists}
\def\A{\forall}
\DeclareMathOperator{\Clo}{Clo}
\DeclareMathOperator{\CSP}{CSP}
\DeclareMathOperator{\Inv}{Inv}
\DeclareMathOperator{\Pol}{Pol}
\DeclareMathOperator{\NP}{NP}
\DeclareMathOperator{\Id}{Id}

\begin{document}
\title{CSP Fast Track}
\author{Arturo}


\begin{abstract}
   In this note 
\end{abstract}

\maketitle

\section{Introduction}
Let $R$ be a set of relation symbols. 
Let $\EuScript{A}=(A, P)$ be a relational structure over $R$.
Let $X$ be a countable set of variables. 
By the \textbf{constraint satisfaction problem} $\CSP(\EuScript{A})$\footnote{More often denoted by $\CSP(P)$.} we mean the following decision problem: 
given a set $\Sigma$ of atomic formulas over $R$, decide whether there is 
%find (or state that it is impossible to find) 
an assignment $(-)^{\EuScript{A}} : X \to A$ and an interpretation of the symbols of $R$ as relations of the appropriate arity such that 
$\EuScript{A} \models \Sigma$; 
i.e. for all $r \in R_n$ and for all $x,y,x_1, \ldots, x_n \in X$ 
\begin{align}
    r(x_1, \ldots, x_n) \in \Sigma & \implies  (x_1^{{\EuScript{A}}}, \ldots, x_n^{{\EuScript{A}}}) \in r^{\EuScript{A}} \\
    x \equiv y \in \Sigma & \implies x^{{\EuScript{A}}} = y^{{\EuScript{A}}}
\end{align}
Clearly, it is enough to find an assignment only for those variables that appear in $\Sigma$. 

Starting point: consider the case when $A$ is finite. 

We shall say that $\CSP({\EuScript{A}})$ is decidable if there is a uniform (unique) algorithm deciding $\CSP({\EuScript{A}})$ for every $\Sigma$ over $R$. 

Let $F$ be a set of function symbols. 
Let $\mathbf{A}=(A, \Phi)$ be an algebra over $F$. 
By the \textbf{constraint satisfaction problem} $\CSP(\mathbf{A})$ we mean the following decision problem:
decide uniformly, that is by a unique algorithm, every $\CSP((A,P))$ such that $P \subseteq \Inv(\Phi)$. 

\begin{definition}
    Let $F$ be a set of function symbols and $\mathbf{A}$ be an algebra over $F$. 
    We denote by $\Clo(\mathbf{A})$ the smallest set containing 
    \begin{equation*}
        \{f^\mathbf{A}: f \in F\} \quad \text{ and } \quad \{\pi^n_i: A^n \to A, 1 \le i \le n, n \in \omega\}
    \end{equation*}
and closed under composition. 
\end{definition}
Goal: prove 

\begin{theorem}
    Let $\mathbf{A}$ be a finite idempotent algebra. 
    Then the following are equivalent: 
    \begin{enumerate}
        \item $\CSP(\mathbf{A})$ is polynomial-time decidable; 
        \item $\Clo(\mathbf{A})$ contains a weak near-unanimity operation; 
        \item for every $\mathbf{B} \in HS(\mathbf{A})$, $\Clo(\mathbf{B}) \neq \{\pi^n_i: 1 \le i \le n, n \in \omega\}$. 
    \end{enumerate}
    Otherwise, $\CSP(\mathbf{A})$ is $\NP$-complete. 
\end{theorem}

\section{Kinds of Operations}

\begin{definition}
    An operation $\phi: A^n \to A$ is called 
    \begin{enumerate}
        \item \textbf{essentially unary} if there is a function $\psi: A \to A$ such that 
        \begin{equation*}
        \phi(a_1, \ldots, a_n) = \psi(a_i)
        \end{equation*}
        for all $a_1, \ldots, a_n \in A$. 
        \item \textbf{idempotent} if $\phi(a, \ldots, a)=a$ for all $a \in A$. 
    \end{enumerate}
\end{definition}

\section{Relational Clones} 
\begin{definition}
    Let $R$ be a set of relation symbols and $\EuScript{A}$ be a relational structure over $R$.
    We denote by $\Clo(\EuScript{A})$ the smallest set containing 
    \begin{equation*}
        \{r^\EuScript{A} : r \in R\} \quad \text{ and } \quad \{\Delta^{(n)} : n \in \omega\}
    \end{equation*}
    and closed under intersection and truncation\footnote{If $\rho \in \Clo(\EuScript{A})$, then also $\{(a_1, \ldots, a_{n-1}): (a_1, \ldots, a_{n-1}, a_n) \in \rho, \text{ for some } a_n \in A \} \in \Clo{\EuScript{A}}$.}.
\end{definition}

\begin{remark}
    Observe that $\Clo(\EuScript{A})$ is given by all the relations $\rho$ of $A$ definable by a first-order primitive positive formula
    (that is, involving only conjunctions and existential quantifications). 
    Recall that $\rho \subseteq A^n$ is definable if there is a formula $\phi(x_1, \ldots, x_n)$ such that 
    \begin{equation*}
        \EuScript{A} \models \phi(a_1, \ldots, a_n) \iff (a_1, \ldots, a_n) \in \rho
    \end{equation*}
\end{remark}

\begin{theorem}
    Let $G$ be a set and $D$ be a finite set of relation symbols. 
    For any $\EuScript{A}=(A,\Gamma)$ over $G$ and $\EuScript{B}=(A,\Delta)$ over $D$ with $\Delta \subseteq \Clo(\EuScript{A})$, $\CSP(\EuScript{B})$ is polynomial-time reducible to $\CSP(\EuScript{A})$.
    \begin{proof}
        Let $\Sigma$ be a set of atomic formulas over $D$.  
        Let $d(x_1, \ldots, x_n) \in \Sigma$. 
        For every $a_1, \ldots, a_n \in A$ 
        \begin{equation}
            \label{equiv}
            \EuScript{B} \models d(a_1, \ldots, a_n)  \iff (a_1, \ldots, a_n) \in \delta 
            \iff \EuScript{A} \models \phi(a_1, \ldots, a_n)
        \end{equation}
        for some $\phi(x_1, \ldots, x_n)$ of the form 
        \begin{equation*}
            \E y_1, \ldots, y_m \,( g_1(z^{1}_{1}, \ldots, z^{1}_{n_1}) \land \cdots \land g_k(z^{k}_{1}, \ldots, z^{k}_{n_k}))
        \end{equation*} 
        where $g_1, \ldots, g_k \in G$ and $z^{i}_{j} \in \{x_1, \ldots, x_n, y_1, \ldots, y_m\}$.
        We can assume (up to renaming of variables) that $y_1, \ldots, y_m$ do not appear in any formula of $\Sigma$.  

        Now, for each $d(x_1, \ldots, x_n) \in \Sigma$ perform the following steps: 
        \begin{enumerate}
            \item add $\{g_1(z^{1}_{1}, \ldots, z^{1}_{n_1}), \ldots, g_k(z^{k}_{1}, \ldots, z^{k}_{n_k})\}$ to $\Sigma$; 
            \item remove $d(x_1, \ldots, x_n)$ from $\Sigma$. 
        \end{enumerate}
        At the the end we obtain a set of equations $T$ over $G$. 
        \textcolor{red}{This is a polynomial-time reduction. (It's reasonable but for me this kind of stuff is like a leap of faith).} 
        By \eqref{equiv} it is clear that we can find an assignment $X \to A$ such that $\EuScript{B} \models \Sigma$ iff we can find an assignment such that $\EuScript{A} \models T$.
    \end{proof} 
\end{theorem}

\begin{corollary}
    Let $\EuScript{A}=(A,P)$ and $\EuScript{B}=(A, \Clo(\EuScript{A}))$. 
    Then 
    \begin{enumerate}
        \item $\CSP(\EuScript{A})$ is polynomial-time decidable iff $\CSP(\EuScript{B})$ is. 
        \item $\CSP(\EuScript{A})$ is $\NP$-complete iff $\CSP(\EuScript{B})$ is. 
    \end{enumerate}
\end{corollary}

\begin{theorem}[\cite{jeavons}]
    Let $\EuScript{A}$ be a relational structure. 
    If $\Pol(\EuScript{A})$ contains essentially unary operations only, $\CSP(\EuScript{A})$ is $\NP$-complete. 
\end{theorem}

\section{Surjective Algebras}
\begin{remark}
    \label{surj_group}
    Let $\mathbf{A}$ be an algebra. 
    Every element of $\Clo(\mathbf{A})$ is surjective iff every element of $\Clo_1(\mathbf{A})$ is. 
    In this case $\Clo_1(\mathbf{A})$ is a group. 
\end{remark}

\begin{theorem}
    Let $F$ be a set of function symbols and 
    let $\mathbf{A}=(A, \Phi)$  be a finite surjective algebra over $F$.
    Let $\mathbf{B}:=(A, \Clo_{\Id}(\mathbf{A}))$. 
    Then   
    \begin{enumerate}
        \item $\CSP(\mathbf{A})$ is polynomial-time decidable iff $\CSP(\mathbf{B})$ is. 
        \item $\CSP(\mathbf{A})$ is $\NP$-complete iff $\CSP(\mathbf{B})$ is. 
    \end{enumerate}
\begin{proof}
    Let $A=\{a_1, \ldots, a_k\}$ and let $\Delta:=\{\{a_1\}, \ldots, \{a_k\}\}$. 
    For every $\rho \in \Inv(\Phi)$, let $r$ be a relation symbol of the same arity and let $R:=\{r: \rho \in \Inv(\Phi)\}$. 
    For every $\delta_i:=\{a_i\} \in \Delta$, let $d_i$ be a relation symbol of the same arity and let $G:= R \cup \{d_i: \delta_i \in \Delta\}$. 
    Let $\EuScript{A}:=(A, \Inv(\Phi))$ and $\EuScript{B}:=(A, \Inv(\Phi) \cup \Delta )$. 

    By definition and by Remark $\CSP(\mathbf{B})$ is polynomial-time equivalent to $\CSP(\mathbf{A})$ iff 
    $\CSP(\EuScript{B})$ is polynomial-time equivalent to $\CSP(\EuScript{A})$.

    That $\CSP(\EuScript{A})$ is polynomial-time reducible to $\CSP(\EuScript{B})$ is obvious.
    Let $\Sigma$ be a set of atomic formulas over $G$ and let $\{x_1, \ldots, x_k\}$ be variables that do not appear in $\Sigma$. 
    By Remark \ref{surj_group}, since $\mathbf{A}$ is surjective, $\Clo_1(\mathbf{A})$ forms a group. 
    Hence, the relation $\sigma$ of Lemma belongs to $\Inv(\Phi)$. 
    Now, perform the following steps: 
        \begin{enumerate}
            \item replace every formula $d_i(x)$ with $x \equiv x_i$; 
            \item add the formula $s(x_1, \ldots, x_k)$. 
        \end{enumerate}
    At the the end we obtain a set of equations $T$ over $R$. 
    \textcolor{red}{This is a polynomial-time reduction.}
    We finally show that we can find an assignment such that $\EuScript{A} \models T$ iff we can find an assignment such that $\EuScript{B} \models \Sigma$.
    Let $(-)^{\EuScript{B}}: X \to A$ be an assignment such that $\EuScript{B} \models \Sigma$. 
    Consider the assignment 
    \begin{equation*}
        (x)^{\EuScript{A}} = 
        \begin{cases}
            (x)^{\EuScript{B}} & \text{ if } x \neq x_i \\
            a_i & \text{ if } x = x_i 
        \end{cases}
    \end{equation*}
    Then $(-)^\EuScript{A}$ is such that $\EuScript{A} \models T$.  
    Conversely, assume that there is an assignment $()^{\EuScript{A}}$ such that $\EuScript{A} \models T$. 
    There is $\psi \in \Clo_1(\mathbf{A})$ such that $x_i^{\EuScript{A}} = \psi(a_i)$ for all $i$. 
    Consider $(-)'^{\EuScript{A}}:=\psi^{-1}(-)^{\EuScript{A}}$. 
    Every relation in $\Inv(\Phi)$ is invariant under $\psi^{-1}$, hence defining $(x)^{\EuScript{B}}:=(x)'^{\EuScript{A}}$ is enough to have $\EuScript{B} \models \Sigma$.  
\end{proof}
\end{theorem}


\begin{thebibliography}{9}
    
    \bibitem{jeavons}
       Jeavons, P. (1998). On the algebraic structure of combinatorial problems, \emph{Theoretical Computer Science} 200, 185–204.
 \end{thebibliography}
\end{document}